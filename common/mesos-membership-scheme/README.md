## Apache Mesos/Marathon Membership Scheme for WSO2 Carbon platform

Mesos membership scheme provides features for automatically discovering WSO2 carbon server clusters deployed on [Apache Mesos](http://mesos.apache.org/) platform.
It can be integrated with Mesos-DNS REST API or Mesos Marathon framework REST API.

### How it works
Under portMappings section of Marathon application definition for all WSO2 products, the first entry is reserved for Hazelcast communication. Since Hazelcast creates point-to-point connections and
advertises its own member port configured in axis2.xml to other members which is used to create those connections, the port being advertised and the local port must be the same. In order
to achieve that we use dynamic host and container ports generated by Mesos. This dynamic port is configured in axis2.xml during the container run-time via Docker init extension script.
The source of this script can be found in [WSO2 Dockerfiles](https://github.com/wso2/Dockerfiles) repo.

#### Marathon REST API
During the Carbon server startup it will query a list of container IP addresses in the given list of clusters via Mesos Marathon API for a given task.
Thereafter Hazelcast network configuration will be updated with the retrieved IP addresses allowing that Carbon instance to connect with all the other members in the cluster.
Similarly once a new member is added to the cluster, all existing members will connect to the new member.

#### Mesos-DNS
This will query Mesos-DNS REST API to get a list of DNS records for given list of clusters (a Carbon cluster maps to a Mesos service). It will wait for a given timeout (default: 10s) until 
DNS records are updated. [Mesos-DNS](https://mesosphere.github.io/mesos-dns/) periodically queries the master and generates DNS records for all services. 
Therefore, there might be a delay to reflect the latest state.

### Installation

1. Apply Carbon kernel patch
      - For Carbon 4.2.0 based products: patch0012
      - Carbon 4.4.x based products: patch001 and patch0005
   Refer to [WSO2 Carbon release matrix](http://wso2.com/products/carbon/release-matrix/) to find out
   the Carbon kernel version of your product. This includes a modification in the Carbon Core component for a custom
   membership scheme implementation to be plugged-in to the kernel.

2. Copy following JAR file to <CARBON_HOME>repository/components/dropins directory.

    ```
    mesos-membership-scheme-<version>.jar
    ```

3. Update axis2.xml with the following configuration:

```
   <clustering class="org.wso2.carbon.core.clustering.hazelcast.HazelcastClusteringAgent" enable="true">
      <parameter name="membershipSchemeClassName">org.wso2.carbon.clustering.mesos.MesosMembershipScheme</parameter>
      <parameter name="membershipScheme">mesos</parameter>

      <!-- Set discovery scheme to either `Marathon` which is the default if none provided, or `MesosDNS` -->
      <parameter name="MESOS_MEMBER_DISCOVERY_SCHEME">Marathon</parameter>

      <!-- Mesos Marathon REST API endpoint to be used with Marathon discovery scheme -->
      <parameter name="MARATHON_ENDPOINT">http://marathon.mesos:8080</parameter>

      <!-- Mesos-DNS REST API endpoint to be used with MesosDNS discovery scheme -->
      <parameter name="MESOS_DNS_ENDPOINT">http://marathon.mesos:8123</parameter>

      <!-- List of Marathon application ids to form a Carbon cluster. Use comma separated values for specifying multiple values.
           Carbon server will connect to all the members deployed under given Marathon tasks via Hazelcast. If no value is provided then it will default to its own Marathon task -->
      <parameter name="MARATHON_APPLICATIONS">wso2esb-manager,wso2esb-worker</parameter>

      <!-- This option flags the membership scheme to use Basic Access Authentication . By default this is set to false -->
      <parameter name="ENABLE_MARATHON_BASIC_AUTH">true</parameter>

      <!-- Username of secured Marathon REST API -->
      <parameter name="MARATHON_USERNAME">username</parameter>

      <!-- Password of secured Marathon REST API -->
      <parameter name="MARATHON_PASSWORD">password</parameter>
   </clustering>
```


### Build Docker images

Dockerfiles and scripts are provided to build the Docker images with minimum overhead.

1. Clone [WSO2 Dockerfiles](https://github.com/wso2/dockerfiles) repo and build base Docker images for WSO2 products.
2. Goto modules/mesos-membership-scheme/dockerfiles/< product_name >/
3. Run the following command

    ```
    ./deploy.sh -v <product_version> -b -E
    ```

4. Deploy the Marathon application
    
    ```
    ./deploy.sh -v 4.9.0 -d
    ```

